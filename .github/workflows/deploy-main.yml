name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: guiamaestra-prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        env:
          REPO_PATH: ${{ secrets.REPO_PATH }}
          INFRASTRUCTURE_PATH: ${{ secrets.INFRASTRUCTURE_PATH }}
          COMPOSE_FILE: ${{ secrets.COMPOSE_FILE }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
          BRANCH_NAME: ${{ secrets.BRANCH_NAME }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: 22
          envs: REPO_PATH,INFRASTRUCTURE_PATH,COMPOSE_FILE,SERVICE_NAME,BRANCH_NAME
          script: |
            echo "üöÄ Starting deployment to Production Environment"
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            cd $REPO_PATH
            
            # Reset any local changes
            git reset --hard
            git clean -fd
            
            # Checkout and pull
            git checkout $BRANCH_NAME
            git fetch origin
            git reset --hard origin/$BRANCH_NAME
            
            echo "‚úÖ Code updated to latest commit"
            git log -1 --oneline
            
            # Go to infrastructure directory and rebuild
            echo "üî® Rebuilding $SERVICE_NAME container..."
            cd $INFRASTRUCTURE_PATH
            docker compose --env-file .env.prod -f $COMPOSE_FILE build --no-cache --pull $SERVICE_NAME
            docker compose --env-file .env.prod -f $COMPOSE_FILE up -d --no-deps $SERVICE_NAME
            
            # Show status
            echo "üìä Container status:"
            docker compose --env-file .env.prod -f $COMPOSE_FILE ps $SERVICE_NAME
            
            # Clean Moodle cache
            echo "üßπ Cleaning Moodle cache..."
            docker compose --env-file .env.prod -f $COMPOSE_FILE exec -T $SERVICE_NAME php /var/www/html/public/admin/cli/purge_caches.php || true
            
            # Show logs (last 20 lines)
            echo "üìã Recent logs:"
            docker compose --env-file .env.prod -f $COMPOSE_FILE logs --tail=20 $SERVICE_NAME
            
            # Clean up old images
            echo "üßπ Cleaning up..."
            docker image prune -f
            
            echo "‚úÖ Deployment completed successfully"
      
      - name: Deployment Success
        run: |
          echo "‚úÖ Deployment to PRODUCTION completed successfully"
          echo "üì¶ Build SHA: ${{ github.sha }}"
          echo "üê≥ Service: moodle-guiamaestra"

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
